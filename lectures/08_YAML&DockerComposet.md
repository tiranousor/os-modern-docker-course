# Основы YAML для конфигураций Docker

## 1. Ключевые термины

**YAML** — текстовый формат сериализации данных, ориентированный на читаемость человеком.

**Скаляр** — простое значение (число, строка, `true/false`, `null`).

**Список (sequence)** — упорядоченная коллекция значений.

**Словарь (mapping)** — неупорядоченная коллекция пар «ключ–значение».

**Якорь/алиас** — механизмы переиспользования фрагментов (DRY).

## 2. Минимальный синтаксис

### 2.1. Пары «ключ–значение»

```yaml
fruit: apple
vegetable: carrot
liquid: water
meat: chicken
```

> Важно: после двоеточия **обязателен** пробел.

### 2.2. Списки (sequence)

```yaml
fruits:
  - apple
  - banana
  - orange
```

Каждый элемент списка помечается `-` на одинаковом уровне отступа.

### 2.3. Словари (mapping)

```yaml
banana:
  calories: 102
  fat: 0.3
  carbs: 27
  protein: 1.3
```

Отступы **задают структуру**. Используются **только пробелы**, табуляция недопустима.

### 2.4. Список словарей

```yaml
fruits:
  - name: banana
    calories: 102
  - name: apple
    calories: 95
```

## 3. Скаляры, строки и кавычки

* YAML допускает строки без кавычек, но значения вида `8080:80` лучше заключать в кавычки:

  ```yaml
  port_mapping: "8080:80"
  ```
* Многострочные строки:

  ```yaml
  preserved: |
    Первая строка
    Вторая строка (переносы сохраняются)

  folded: >
    Первая строка
    Вторая строка (переносы сворачиваются в пробел)
  ```

## 4. Комментарии и порядок

* Комментарии начинаются с `#`:

  ```yaml
  # это комментарий
  name: app  # комментарий в конце строки
  ```
* Порядок ключей в словаре значения не имеет; порядок в списке — важен.

## 5. DRY: якори и алиасы

```yaml
x-default-env: &default-env
  LOG_LEVEL: info
  ENV: prod

service_a:
  environment:
    <<: *default-env
    SERVICE: a

service_b:
  environment:
    <<: *default-env
    SERVICE: b
```

## 6. Типовые ошибки и диагностика

* Отсутствует пробел после двоеточия (`name:app` — неверно).
* Смешанные уровни отступов в списках/словарях.
* Табуляция вместо пробелов.
* Одновременное присвоение скаляра и вложенного объекта одному ключу:

  ```yaml
  calories: 102
    fat: 0.3   # ошибка
  ```

---

# Docker Compose: управление многоконтейнерными приложениями на YAML

## 1. Ключевые термины

**Docker Compose** — это инструмент, который позволяет запускать и управлять **многоконтейнерными приложениями** с помощью одного файла конфигурации `docker-compose.yml`.

Он нужен, когда:

* приложение состоит из нескольких сервисов (например, фронтенд, бэкенд, база данных, кэш);
* контейнеры должны взаимодействовать между собой;
* нужно быстро поднимать и останавливать целую систему командой.

Вместо длинных цепочек `docker run`, мы описываем всё один раз в YAML и запускаем одной командой:
```bash
docker compose up
```
### 2. Пример: Simple Voting App

Для демонстрации возьмем тестовое приложение от разработчиков Docker — **Simple Voting App**.
Оно состоит из нескольких компонентов:

| Компонент     | Назначение                                | Технология     |
| ------------- | ----------------------------------------- | -------------- |
| **VotingApp** | Интерфейс голосования (“Cats” или “Dogs”) | Python (Flask) |
| **Redis**     | Кэш для временного хранения голосов       | Redis          |
| **Worker**    | Сервис обработки и передачи данных в БД   | .NET           |
| **Postgres**  | Хранение результатов голосования          | PostgreSQL     |
| **ResultApp** | Отображение итогов голосования            | Node.js        |

Архитектура напоминает фабрику:

* **VotingApp** быстро складывает «заявки» на склад Redis;
* **Worker** забирает данные и сохраняет их в Postgres;
* **ResultApp** достает готовый результат для пользователя.

---

### 3. Как выглядел запуск без Compose

До появления Compose каждую часть запускали вручную:

```bash
docker run -d --name redis redis
docker run -d --name db postgres:9.4
docker run -d --name vote -p 5000:80 --link redis:redis voting-app
docker run -d --name result -p 5001:80 --link db:db result-app
docker run -d --name worker --link redis:redis --link db:db worker
```

Проблема: все работает, но контейнеры не знают, как друг друга находить, если не прописать `--link`.
Кроме того, изменять или перезапускать такой стек — тяжело и неудобно.

---

### 4. Переход к Docker Compose

Теперь опишем всё это в **`docker-compose.yml`**.

```yaml
version: "2"

services:
  redis:
    image: redis

  db:
    image: postgres:9.4

  vote:
    build: ./vote
    ports:
      - "5000:80"
    depends_on:
      - redis

  worker:
    build: ./worker
    depends_on:
      - redis
      - db

  result:
    build: ./result
    ports:
      - "5001:80"
    depends_on:
      - db
```

---

### 5. Разбор структуры

| Элемент      | Значение                                                         |
| ------------ | ---------------------------------------------------------------- |
| `version`    | версия формата Docker Compose файла                              |
| `services`   | ключ, под которым описываются все контейнеры                     |
| `image`      | готовый образ из Docker Hub                                      |
| `build`      | путь к директории с `Dockerfile` (если образ нужно собрать)      |
| `ports`      | проброс портов: `"хост:контейнер"`                               |
| `depends_on` | порядок запуска (например, Redis должен стартовать до фронтенда) |

---

### 6. Как это работает при запуске

1. **Docker Compose читает файл `docker-compose.yml`.**
2. **Создает сеть по умолчанию**, объединяя все контейнеры.
3. **Запускает сервисы** в порядке зависимостей.
4. **Каждый контейнер доступен по имени сервиса**, без ручного `--link`.

---

### 7. Команды Docker Compose

| Команда                  | Назначение                                   |
| ------------------------ | -------------------------------------------- |
| `docker compose up`      | Собрать и запустить все приложение           |
| `docker compose down`    | Остановить и удалить контейнеры, сети и тома |
| `docker compose ps`      | Показать запущенные сервисы                  |
| `docker compose logs -f` | Просмотреть логи в реальном времени          |
| `docker compose build`   | Собрать образы без запуска                   |
| `docker compose restart` | Перезапустить сервисы                        |

---

## 8. Основные ключи

* `services` — перечень сервисов приложения.
* `image` — готовый образ из реестра (Docker Hub и др.).
* `build: ./path` — сборка образа из каталога с `Dockerfile`.
* `ports: ["HOST:CONTAINER"]` — проброс портов (кавычки — хорошая практика).
* `environment` — переменные окружения (список или словарь).
* `volumes` — монтирование томов/директорий.
* `depends_on` — декларирует порядок запуска (не гарантирует «готовность» сервиса).
* `restart` — политика перезапуска (`no`, `on-failure`, `always`, `unless-stopped`).

Важно: Docker Compose **использует YAML**, поэтому чем лучше вы понимаете структуру YAML, тем проще вам будет настраивать и масштабировать контейнерные приложения.











