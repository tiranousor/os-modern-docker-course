# Docker Registry

## 1) Термины

- Image (образ): набор слоев файловой системы и метаданных. Из образа запускают контейнер.
- Container (контейнер): запущенный процесс, использующий образ как файловую систему и настройки.
- Registry (реестр): сервер, который хранит образы и предоставляет API для push и pull.
- Repository (репозиторий): логическая сущность внутри registry для одного семейства образов, например `myteam/app`.
- Tag (тег): имя версии внутри репозитория, например `:1.0`, `:latest`.
- Digest: криптографический хэш манифеста образа. Используется для точной фиксации версии.

---

## 2) Как Docker понимает имя образа

Формат имени образа:

```

[REGISTRY_HOST[:PORT]/]NAMESPACE/REPOSITORY[:TAG]

````

Примеры:

- `nginx`  
  означает `docker.io/library/nginx:latest`
- `myorg/api:1.2`
- `dev-registry:5000/student01/web:http`

Правила по умолчанию:

- если registry не указан, используется Docker Hub `docker.io`
- если tag не указан, используется `latest`
- для official images на Docker Hub namespace равен `library`

---

## 3) Что делает Docker при run, pull, push

### `docker run nginx`

1. Docker проверяет, есть ли образ локально
2. если образа нет, Docker скачивает его из registry командой pull
3. Docker создат контейнер и запускает его

### `docker pull`

Скачивает образ, но не запускает контейнер:

```bash
docker pull nginx:latest
````

### `docker push`

Отправляет образ в registry. Для push в приватный registry в имени образа должен быть указан адрес registry:

```bash
docker push dev-registry:5000/myapp:1.0
```

---

## 4) Логин в приватный registry

Если registry приватный, требуется аутентификация:

```bash
docker login <registry-host[:port]>
```

После логина Docker сохраняет данные доступа локально. Обычно это `~/.docker/config.json` или credential helper.

---

## 5) Мини-пример: как запушить образ в приватный registry

Сборка локального образа:

```bash
docker build -t myapp:1.0 .
```

Перетегирование, чтобы указать адрес registry:

```bash
docker tag myapp:1.0 dev-registry:5000/myapp:1.0
```

Push в registry:

```bash
docker push dev-registry:5000/myapp:1.0
```

Pull на другой машине:

```bash
docker pull dev-registry:5000/myapp:1.0
```

---

## 6) Почему HTTP registry обычно не работает без дополнительных настроек

Docker по умолчанию ожидает работу registry по HTTPS, потому что:

* по сети передаются учтные данные доступа к registry (логины, пароли, токены)
* по сети передаются данные образов (слои)
* требуется защита от перехвата трафика и подмены сервера

Если registry отвечает по HTTP, Docker часто выдает ошибки и отказывается работать, пока явно не разрешить небезопасный режим.

### Insecure registry

Insecure registry: это режим, при котором Docker разрешает работу с registry по HTTP.

Этот режим допустим для учебных стендов и временных внутренних окружений. Для продакшена его не используют.

---

## 7) TLS, аутентификация и авторизация: что нужно для нормального registry

Для безопасной и управляемой работы приватного registry обычно нужны три компонента.

### 7.1 TLS (HTTPS)

TLS решает задачи безопасности канала:

* шифрует трафик, чтобы в сети нельзя было перехватить учтные данные и содержимое слоев
* позволяет клиенту проверить, что он подключился к нужному серверу, если сертификату доверяют

Если используется самоподписанный сертификат, его нужно добавить в доверенные на всех клиентах Docker, иначе будет ошибка доверия сертификату.

### 7.2 Аутентификация

Аутентификация отвечает на вопрос, какой пользователь или сервис выполняет запрос.

Примеры механизмов:

* логин и пароль
* токен
* сервисный аккаунт в облаке

Без аутентификации registry может быть доступен анонимно, что обычно недопустимо для приватных образов.

### 7.3 Авторизация

Авторизация отвечает на вопрос, какие действия разрешены конкретному пользователю.

Типичные требования в организации:

* серверы развертывания в продакшене должны иметь только pull из `prod/*`
* CI должен иметь push в `staging/*`, но не должен иметь push в `prod/*`
* разработчики должны иметь доступ только к своему проекту или команде
* администраторы должны иметь расширенные права на управление

RBAC (Role Based Access Control): управление доступом по ролям. Это стандартный способ реализации авторизации в registry-системах.

### 7.4 Почему `registry:2` с htpasswd часто недостаточен

Базовый `registry:2` с htpasswd обычно дат:

* аутентификацию на уровне registry
* возможность включить TLS

Но он не предоставляет удобный и полный RBAC по ролям и проектам. В простом варианте получается ограниченная модель доступа, где сложно реализовать раздельные права для команд и окружений.

### 7.5 Зачем используются Harbor, Artifactory, Nexus, GitLab Registry и managed registry в облаке

Такие решения добавляют возможности, которые требуются в корпоративной эксплуатации:

* RBAC по ролям и проектам
* изоляция проектов и команд
* аудит действий пользователей
* сканирование образов на уязвимости
* политики публикации и запреты по качеству/уязвимостям
* политики жизненного цикла образов и очистка мусора
* интеграции с LDAP/AD/OIDC и CI/CD


