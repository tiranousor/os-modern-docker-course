## Лабораторная 1: шифрование изображений

### Цель

1. Реализовать **минимум два разных** метода шифрования изображений из семейств:

* **Потоковый** (XOR с ключевым потоком),
* **Блочный** (AES в режимах),
* **Перестановочный** (перестановка + подстановка).

2. Обеспечить **обратимость** (дешифрованием восстановить исходник **побитово**).
3. Оценить криптосвойства: **гистограммы**, **корреляции соседних пикселей**, **энтропию**, **NPCR/UACI**, **чувствительность к ключу**.

### Что можно / нельзя

* Язык — любой. Библиотеки — **только для загрузки/сохранения изображений** и **AES** (для режимов шифрования).
* Все генераторы потоков, перестановки и пр. — **своя реализация**, без копипаста чужих «image encryption» скриптов.

### Датасет

* 3 изображения 512×512: градиент, текстурка, фото (RGB).
* + 1 свое (≥256×256).

### Выберите **2 семейства** и реализуйте

**A) Потоковый (XOR с потоковым ключом)**

* Получаете **keystream** длиной в байты изображения: LCG/xorshift/хаотическое отображение/RC4-подобный PRGA (собственный).
* `cipher = (plaintext) XOR (keystream)` (ознакомтесь с формулой).
* Требуется: описать формулы/инициализацию **KEY** и **IV/nonce**, показать чувствительность к ключу (изменить 1 бит в KEY → **NPCR/UACI** между двумя шифрами).

**B) Блочный (AES-ECB, CBC/CFB и CTR)**

* Сравнить: **ECB** (ожидается «плиточный» протек), **CBC или CFB**, и **CTR** (должны давать «шум»).
* Требуется: корректный паддинг/размеры, объяснить **зачем IV/nonce** и почему их **нельзя повторять**.

**C) Перестановочный (confusion + diffusion)**

* Варианты:

  * случайная перестановка блоков 8×8/16×16 (Fisher–Yates под управлением PRNG от KEY+IV), затем подстановка (XOR-поток);
  * Arnold cat map по каналам (число итераций задаете параметром) + подстановка;
  * bit-plane shuffling (перестановка битовых плоскостей 0–7) + подстановка.
* Требуется: описать, как строится перестановка/число шагов из **KEY + IV/nonce**; показать **обратимость**.

> **Важное правило IV/nonce:** для CBC/CFB/CTR и потоковых схем IV/nonce должен **меняться при каждом шифровании**. Храните его рядом с шифром (в имени файла или .meta). Повтор IV/nonce при том же KEY — **ошибка**.

### Формат утилиты

Командная строка:

```
cryptopic --mode encrypt|decrypt --in img.png --out out.bin|out.png \
          --algo stream|aes-ecb|aes-cbc|aes-ctr|perm-mix \
          --key "секрет" [--iv HEX|--nonce HEX|--meta META.json]
```

* При `encrypt` программа **сама генерирует** случайный IV/nonce (и сохраняет его в `META.json` или в имя файла).
* При `decrypt` читает IV/nonce из `META.json`/имени.

### Метрики (реализовать и показать)

1. **Гистограммы** каналов (до/после).
2. **Корреляция соседних пикселей** H/V/D (до/после).
3. **Энтропия** каналов (ожидаемо близко к 8 бит после шифрования).
4. **NPCR / UACI** между:

   * шифрами при ключах, отличающихся на 1 бит;
   * (для иллюстрации) исходником и шифром.
     Формулы кратко в отчете:
   * `NPCR = (изменившиеся пиксели / общее число) * 100%`
   * `UACI = (1/N) * Σ |C1 - C2| / 255 * 100%`
5. **Чувствительность к ключу (avalanche)** — доля изменившихся бит в шифре при изменении 1 бита KEY (ожидаемо ~50%).

### Что сдавать

* `src/` — код; `README.md` — как запускать; `report.md`:

  * кратко алгоритмы и схемы;
  * как формируете/храните IV/nonce;
  * метрики (таблицы/графики) и выводы;
  * сравнение AES режимов (ECB vs CBC/CTR);
  * **проверка обратимости** (хэши исходника и дешифра).
* Папка `imgs/` (исходные, шифры, дешифры).

### Мини-памятка

* **KEY — секретный**, **IV/nonce — публичный, но уникальный** на шифрование.
* Повтор IV/nonce при том же KEY — запрещен.
* В отчете — схемы, формулы, метрики, скрины «до/после».

---
## Шаблон структуры репозитория

```
CryptoPic/
  src/            # код
  imgs/           # исходные и результаты
  results/        # графики, метрики (csv/png), meta.json
  README.md       # запуск, параметры
  report.pdf      # отчет
```

`meta.json` пример: `{ "algo":"aes-ctr", "key_hash":"...", "nonce":"HEX", "date":"..." }`
